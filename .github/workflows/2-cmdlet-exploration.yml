name: Step 2, Cmdlet Exploration

# This step triggers when the learner creates the cmdlet exploration script
# This step validates the script and moves to step 3

# Reference: https://docs.github.com/en/actions/learn-github-actions/events-that-trigger-workflows  
on:
  # We'll run this workflow when:
  # - Learner pushes changes to main branch with cmdlet exploration script
  push:
    branches:
      - main
    paths:
      - 'cmdlet-exploration.ps1'
  # Allow manual triggering for testing
  workflow_dispatch:

# Reference: https://docs.github.com/en/actions/security-guides/automatic-token-authentication
permissions:
  # Need `contents: read` to checkout the repository
  # Need `contents: write` to update the step in the README
  contents: write

jobs:
  check_cmdlet_script:
    name: Check cmdlet exploration script

    # We will only run this action when:
    # 1. This repository isn't the template repository
    # 2. The cmdlet-exploration.ps1 file exists  
    # 3. We're currently on step 2
    if: ${{ !github.event.repository.is_template && github.repository != 'sup3r7-fabio/pwsh-github-skills-tutorial' }}

    # We'll run Ubuntu for performance
    runs-on: ubuntu-latest

    steps:
      # We'll need to check out the repository so that we can read the files
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Check if we're on the right step and script exists
      - name: Check current step and files
        id: check_step
        run: |
          echo "Checking current step and files..."
          
          # Check if we're on step 2
          if grep -q '<details id=2>' README.md; then
            echo "Currently on step 2, checking for cmdlet exploration script..."
            echo "on_step_2=true" >> $GITHUB_OUTPUT
            
            # Check if the cmdlet script exists
            if [ -f "cmdlet-exploration.ps1" ]; then
              echo "âœ… Found cmdlet-exploration.ps1"
              echo "script_exists=true" >> $GITHUB_OUTPUT
              
              # Validate script content - check for essential cmdlets
              required_cmdlets=("Get-Date" "Get-Location" "Get-ChildItem" "Get-ComputerInfo" "Get-Process")
              valid_count=0
              
              for cmdlet in "${required_cmdlets[@]}"; do
                if grep -q "$cmdlet" "cmdlet-exploration.ps1"; then
                  echo "âœ… Found $cmdlet in script"
                  ((valid_count++))
                else
                  echo "âŒ Missing $cmdlet in script"
                fi
              done
              
              if [ $valid_count -ge 4 ]; then
                echo "âœ… Script contains sufficient cmdlet examples ($valid_count/5)"
                echo "script_valid=true" >> $GITHUB_OUTPUT
              else
                echo "âŒ Script missing required cmdlets (found $valid_count/5)"
                echo "script_valid=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "âŒ cmdlet-exploration.ps1 not found"
              echo "script_exists=false" >> $GITHUB_OUTPUT
              echo "script_valid=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Not on step 2, no action needed"
            echo "on_step_2=false" >> $GITHUB_OUTPUT
          fi

      # Install PowerShell for testing
      - name: Install PowerShell
        if: steps.check_step.outputs.on_step_2 == 'true' && steps.check_step.outputs.script_exists == 'true'
        shell: bash
        run: |
          # Install PowerShell on Ubuntu
          wget -q https://github.com/PowerShell/PowerShell/releases/download/v7.3.9/powershell_7.3.9-1.deb_amd64.deb
          sudo dpkg -i powershell_7.3.9-1.deb_amd64.deb
          sudo apt-get install -f

      # Test the PowerShell script
      - name: Test cmdlet exploration script
        if: steps.check_step.outputs.on_step_2 == 'true' && steps.check_step.outputs.script_exists == 'true'
        shell: bash
        run: |
          echo "Testing cmdlet exploration script..."
          
          # Test script syntax and basic execution
          if timeout 30s pwsh -Command "& { . './cmdlet-exploration.ps1' }" > script_output.txt 2>&1; then
            echo "âœ… Script executed successfully"
            echo "SCRIPT_EXECUTION_VALID=true" >> $GITHUB_ENV
            
            # Check if output contains expected elements
            if grep -q "PowerShell Cmdlet Exploration" script_output.txt; then
              echo "âœ… Script produces expected output"
            else
              echo "âš ï¸  Script output doesn't match expected format"
            fi
            
            # Display first few lines of output for debugging
            echo "Script output preview:"
            head -10 script_output.txt
            
          else
            echo "âŒ Script failed to execute or timed out"
            echo "SCRIPT_EXECUTION_VALID=false" >> $GITHUB_ENV
            
            # Show error output for debugging
            echo "Error output:"
            cat script_output.txt
            exit 1
          fi

      # Move to step 3 if validation passes
      - name: Update to step 3
        if: steps.check_step.outputs.on_step_2 == 'true' && steps.check_step.outputs.script_valid == 'true' && env.SCRIPT_EXECUTION_VALID == 'true'
        uses: skills/action-update-step@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          from_step: 2
          to_step: 3

      # Provide feedback to learner
      - name: Create feedback comment
        if: steps.check_step.outputs.on_step_2 == 'true' && steps.check_step.outputs.script_valid == 'true' && env.SCRIPT_EXECUTION_VALID == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const feedbackMessage = `
            ðŸš€ **Outstanding progress!** Your cmdlet exploration script is working perfectly!

            âœ… **What you mastered:**
            - PowerShell's Verb-Noun cmdlet naming convention
            - Essential cmdlets: \`Get-Date\`, \`Get-Location\`, \`Get-ChildItem\`
            - System information gathering with \`Get-ComputerInfo\`
            - Process management with \`Get-Process\`
            - Colorful output formatting with \`Write-Host\`

            ðŸ” **Key insight:** You're now seeing how PowerShell's consistent naming makes it intuitive to guess command names!

            ðŸ“š **Ready for Step 3!** Next, you'll learn about PowerShell's powerful help system - one of its best features for learning and troubleshooting.
            `;
            
            try {
              const commits = await github.rest.repos.listCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 1
              });
              
              if (commits.data.length > 0) {
                await github.rest.repos.createCommitComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  commit_sha: commits.data[0].sha,
                  body: feedbackMessage
                });
              }
            } catch (error) {
              console.log('Could not create commit comment, will skip');
            }
