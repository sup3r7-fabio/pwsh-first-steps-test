name: Step 0, Start

# This step triggers after the learner creates a new repository from the template
# This step sets up the course and moves to step 1

# Reference: https://docs.github.com/en/actions/learn-github-actions/events-that-trigger-workflows
on:
  # We'll run this workflow when the learner creates a repository from this template
  # This workflow will run on the first push to main branch
  push:
    branches:
      - main
  # Allow manual triggering for testing
  workflow_dispatch:

# Reference: https://docs.github.com/en/actions/security-guides/automatic-token-authentication
permissions:
  # Need `contents: read` to checkout the repository
  # Need `contents: write` to update the step in the README
  contents: write

jobs:
  on_start:
    name: On start

    # We will only run this action when:
    # 1. This repository isn't the template repository
    # 2. The README still shows step 0 (hasn't been updated yet)
    # Reference: https://docs.github.com/en/actions/learn-github-actions/contexts
    # Reference: https://docs.github.com/en/actions/learn-github-actions/expressions
    if: >-
      ${{ !github.event.repository.is_template
      && github.repository != 'sup3r7-fabio/pwsh-github-skills-tutorial' }}

    # We'll run Ubuntu for performance instead of Mac or Windows
    runs-on: ubuntu-latest

    steps:
      # We'll need to check out the repository so that we can edit the README
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Let's get all the branches
          token: ${{ secrets.GITHUB_TOKEN }}

      # Check if we're still on step 0
      - name: Check current step
        id: check_step
        run: |
          echo "Checking if we need to setup the course..."
          if grep -q '<details id=0>' README.md; then
            echo "Found step 0, proceeding with setup"
            echo "setup_needed=true" >> $GITHUB_OUTPUT
          else
            echo "Step 0 not found, course already started"
            echo "setup_needed=false" >> $GITHUB_OUTPUT
          fi

      # Update README to show step 1 and hide step 0
      - name: Update to step 1
        if: steps.check_step.outputs.setup_needed == 'true'
        uses: skills/action-update-step@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FROM_STEP: 0
          TO_STEP: 1

      # Welcome the learner to the course
      - name: Create welcome comment
        if: steps.check_step.outputs.setup_needed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const welcomeMessage = `
            ðŸŽ‰ **Welcome to PowerShell First Steps!** 

            Your course repository has been successfully created. Here's what happens next:

            1. ðŸ“– Read through **Step 1** in your README below
            2. ðŸ’» Follow the instructions to create your first PowerShell script  
            3. âœ… Commit your changes to automatically progress to the next step

            **Estimated time:** About 1 hour total (5 steps)

            Happy learning! If you get stuck, check the "Get help" section at the bottom of the README.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number || 1,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: welcomeMessage
            });
