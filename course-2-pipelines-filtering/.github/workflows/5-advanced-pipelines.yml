name: Step 5, Advanced Pipeline Mastery

# This workflow validates advanced pipeline techniques and completes the course

on:
  push:
    branches: [main]
    paths:
      - 'step5-advanced-pipelines.ps1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  validate_advanced_pipelines:
    name: Validate Advanced Pipeline Skills
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Step 5 Script Exists
        shell: pwsh
        run: |
          if (Test-Path "step5-advanced-pipelines.ps1") {
            Write-Host "‚úÖ Found step5-advanced-pipelines.ps1" -ForegroundColor Green
            $content = Get-Content "step5-advanced-pipelines.ps1" -Raw
            
            # Check for advanced pipeline concepts
            $requiredConcepts = @{
              'ForEach-Object' = 'Advanced object processing'
              '-ErrorAction' = 'Error handling in pipelines'
              'switch.*\{' = 'Complex conditional logic'
              'PSCustomObject' = 'Custom object creation'
              'System\.Diagnostics\.Stopwatch' = 'Performance measurement'
            }
            
            $conceptsFound = 0
            foreach ($concept in $requiredConcepts.Keys) {
              if ($content -match $concept) {
                Write-Host "‚úÖ Found: $($requiredConcepts[$concept])" -ForegroundColor Green
                $conceptsFound++
              } else {
                Write-Host "‚ö†Ô∏è  Missing: $($requiredConcepts[$concept])" -ForegroundColor Yellow
              }
            }
            
            if ($conceptsFound -ge 3) {
              Write-Host "üéâ Excellent coverage of advanced concepts!" -ForegroundColor Cyan
            } else {
              Write-Host "‚ö†Ô∏è  Consider adding more advanced examples." -ForegroundColor Yellow
            }
          } else {
            Write-Host "‚ùå step5-advanced-pipelines.ps1 not found!" -ForegroundColor Red
            exit 1
          }

      - name: Execute Step 5 Script
        shell: pwsh
        run: |
          Write-Host "üîÑ Testing your advanced pipeline script..." -ForegroundColor Cyan
          try {
            ./step5-advanced-pipelines.ps1
            Write-Host "‚úÖ Script executed successfully!" -ForegroundColor Green
          } catch {
            Write-Host "‚ùå Script execution failed: $($_.Exception.Message)" -ForegroundColor Red
            exit 1
          }

      - name: Advanced Pipeline Skills Test
        shell: pwsh
        run: |
          Write-Host "üß™ Testing advanced pipeline mastery..." -ForegroundColor Cyan
          
          # Test complex pipeline chain
          $complexResult = Get-Process | 
            Where-Object { $_.WorkingSet -gt 10MB } |
            Select-Object Name, @{Name='MemoryMB';Expression={[math]::Round($_.WorkingSet/1MB,2)}} |
            Group-Object {
              switch ($_.MemoryMB) {
                {$_ -gt 500} { 'High' }
                {$_ -gt 100} { 'Medium' }
                default { 'Low' }
              }
            } |
            Sort-Object Name
          
          if ($complexResult.Count -ge 1) {
            Write-Host "‚úÖ Complex pipeline chain works: $($complexResult.Count) categories" -ForegroundColor Green
          }
          
          # Test custom object creation
          $customObjects = 1..10 | ForEach-Object {
            [PSCustomObject]@{
              Number = $_
              Square = $_ * $_
              IsEven = ($_ % 2) -eq 0
            }
          }
          
          if ($customObjects.Count -eq 10 -and $customObjects[0].Square -eq 1) {
            Write-Host "‚úÖ Custom object creation works correctly" -ForegroundColor Green
          }
          
          # Test performance measurement
          $stopwatch = [System.Diagnostics.Stopwatch]::StartNew()
          $result = 1..100 | ForEach-Object { $_ * 2 }
          $stopwatch.Stop()
          
          if ($stopwatch.ElapsedMilliseconds -ge 0) {
            Write-Host "‚úÖ Performance measurement works: $($stopwatch.ElapsedMilliseconds)ms" -ForegroundColor Green
          }
          
          Write-Host "üéØ AMAZING! You've achieved pipeline mastery!" -ForegroundColor Magenta

      - name: Course Completion Celebration
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "üéâüéâüéâ COURSE 2 COMPLETED! üéâüéâüéâ" -ForegroundColor Magenta
          Write-Host ""
          Write-Host "You have successfully mastered:" -ForegroundColor Cyan
          Write-Host "‚úÖ Pipeline object flow" -ForegroundColor Green
          Write-Host "‚úÖ Advanced filtering with Where-Object" -ForegroundColor Green
          Write-Host "‚úÖ Data transformation with Select-Object" -ForegroundColor Green
          Write-Host "‚úÖ Sorting and grouping techniques" -ForegroundColor Green
          Write-Host "‚úÖ Complex pipeline chains" -ForegroundColor Green
          Write-Host "‚úÖ Performance optimization" -ForegroundColor Green
          Write-Host ""
          Write-Host "üöÄ You're ready for Course 3: PowerShell Functions & Modules!" -ForegroundColor Yellow
          Write-Host ""

      - name: Create Course Completion Badge
        shell: pwsh
        run: |
          $badge = @"
          # üèÜ Course 2 Completion Badge
          
          **Congratulations!** You have successfully completed:
          
          ## PowerShell Pipelines & Filtering
          
          **Skills Mastered:**
          - ‚úÖ Pipeline object manipulation
          - ‚úÖ Advanced filtering techniques  
          - ‚úÖ Data transformation and selection
          - ‚úÖ Sorting and statistical analysis
          - ‚úÖ Complex pipeline architectures
          
          **Completion Date:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
          
          ---
          
          Ready for the next challenge? Check out **Course 3: PowerShell Functions & Modules**!
          "@
          
          $badge | Out-File -FilePath "COURSE-2-COMPLETION.md" -Encoding utf8
          Write-Host "‚úÖ Created completion badge: COURSE-2-COMPLETION.md" -ForegroundColor Green

      - name: Final Step Update
        uses: skills/action-update-step@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          from_step: 5
          to_step: X
