name: Step 5, Module Distribution

on:
  push:
    branches: [main]
    paths:
      - 'step5-distribution.ps1'
      - '**/step5-distribution.ps1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  validate_distribution:
    name: Validate Module Distribution
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Distribution Script
        shell: pwsh
        run: |
          $scriptPath = "step5-distribution.ps1"
          if (-not (Test-Path $scriptPath)) {
            $scriptPath = "course-3-functions-modules/step5-distribution.ps1"
          }
          
          if (Test-Path $scriptPath) {
            Write-Host "‚úÖ Found distribution script!" -ForegroundColor Green
            
            $content = Get-Content $scriptPath -Raw
            $concepts = @(
              'New-ModuleManifest',
              'Test-ModuleManifest',
              'Export-ModuleMember',
              'ModuleVersion'
            )
            
            $found = 0
            foreach ($concept in $concepts) {
              if ($content -match $concept) { $found++ }
            }
            
            if ($found -ge 2) {
              Write-Host "‚úÖ Distribution concepts found!" -ForegroundColor Green
              & $scriptPath
              Write-Host "üéâ Course 3 Complete! You are now a PowerShell function and module expert!" -ForegroundColor Magenta
            } else {
              Write-Host "‚ùå Missing distribution concepts" -ForegroundColor Red
              exit 1
            }
          } else {
            Write-Host "‚ùå Distribution script not found!" -ForegroundColor Red
            exit 1
          }

      - name: Course Completion
        shell: pwsh
        run: |
          Write-Host "üèÜ CONGRATULATIONS!" -ForegroundColor Magenta
          Write-Host "You have successfully completed Course 3: PowerShell Functions & Modules" -ForegroundColor Green
          Write-Host ""
          Write-Host "üéØ Skills Mastered:" -ForegroundColor Cyan
          Write-Host "  ‚úÖ PowerShell Function Development" -ForegroundColor Green
          Write-Host "  ‚úÖ Parameter Validation and Attributes" -ForegroundColor Green
          Write-Host "  ‚úÖ Advanced Function Features" -ForegroundColor Green
          Write-Host "  ‚úÖ PowerShell Module Creation" -ForegroundColor Green
          Write-Host "  ‚úÖ Module Distribution and Best Practices" -ForegroundColor Green
          Write-Host ""
          Write-Host "üöÄ You are ready for enterprise PowerShell development!" -ForegroundColor Yellow

      - name: Final Step Update
        uses: skills/action-update-step@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          from_step: 5
          to_step: X
